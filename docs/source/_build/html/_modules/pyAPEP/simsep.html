<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyAPEP.simsep &mdash; pyAPEP 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="canonical" href="https://nahyeonan.github.io/pyAPEP/_modules/pyAPEP/simsep.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> pyAPEP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyAPEP.html">pyAPEP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Citation.html">Citation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyAPEP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>pyAPEP.simsep</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyAPEP.simsep</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">simsep - Python module for real PSA simulation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># %% Import packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#from numpy.lib.function_base import _parse_input_dimensions</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">solve_ivp</span>
 
<span class="c1"># %% Global varaiebls</span>
<span class="n">R_gas</span> <span class="o">=</span> <span class="mf">8.3145</span>      <span class="c1"># 8.3145 J/mol/K</span>
 
<span class="c1"># %% column (bed) class</span>
<span class="k">def</span> <span class="nf">Ergun</span><span class="p">(</span><span class="n">C_array</span><span class="p">,</span><span class="n">T_array</span><span class="p">,</span> <span class="n">M_molar</span><span class="p">,</span> <span class="n">mu_vis</span><span class="p">,</span> <span class="n">D_particle</span><span class="p">,</span><span class="n">epsi_void</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">d_fo</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">rho_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">C_array</span><span class="p">,</span> <span class="n">M_molar</span><span class="p">):</span>
        <span class="n">rho_g</span> <span class="o">=</span> <span class="n">rho_g</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">c</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">C_array</span><span class="p">:</span> 
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="n">cc</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T_array</span>
    <span class="n">dP</span> <span class="o">=</span> <span class="n">d</span><span class="nd">@P</span>
    
    <span class="n">Vs_Vg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi_void</span><span class="p">)</span><span class="o">/</span><span class="n">epsi_void</span>
    <span class="n">A</span> <span class="o">=</span><span class="mf">1.75</span><span class="o">*</span><span class="n">rho_g</span><span class="o">/</span><span class="n">D_particle</span><span class="o">*</span><span class="n">Vs_Vg</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mi">150</span><span class="o">*</span><span class="n">mu_vis</span><span class="o">/</span><span class="n">D_particle</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Vs_Vg</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">dP</span>
 
    <span class="n">ind_posi</span> <span class="o">=</span> <span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="o">*</span><span class="n">C</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">ind_nega</span> <span class="o">=</span> <span class="n">ind_posi</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="n">v_pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span><span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">])</span>
    <span class="n">v_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">])</span>
    
    <span class="n">v_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">v_return</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_pos</span>
    <span class="n">v_return</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_neg</span>
    
    <span class="n">dv_return</span> <span class="o">=</span> <span class="n">d_fo</span><span class="nd">@v_return</span>
    <span class="k">return</span> <span class="n">v_return</span><span class="p">,</span> <span class="n">dv_return</span>

<span class="k">def</span> <span class="nf">Ergun_test</span><span class="p">(</span><span class="n">dP</span><span class="p">,</span><span class="n">M_molar</span><span class="p">,</span> <span class="n">mu_vis</span><span class="p">,</span> <span class="n">D_particle</span><span class="p">,</span><span class="n">epsi_void</span><span class="p">):</span>
    <span class="n">rho_g</span> <span class="o">=</span> <span class="mi">40</span><span class="o">*</span><span class="n">M_molar</span>
    <span class="n">Vs_Vg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi_void</span><span class="p">)</span><span class="o">/</span><span class="n">epsi_void</span>
    <span class="n">A</span> <span class="o">=</span><span class="mf">1.75</span><span class="o">*</span><span class="n">rho_g</span><span class="o">/</span><span class="n">D_particle</span><span class="o">*</span><span class="n">Vs_Vg</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dP</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mi">150</span><span class="o">*</span><span class="n">mu_vis</span><span class="o">/</span><span class="n">D_particle</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Vs_Vg</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dP</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">dP</span>
 
    <span class="n">ind_posi</span> <span class="o">=</span> <span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="o">*</span><span class="n">C</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">ind_nega</span> <span class="o">=</span> <span class="n">ind_posi</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="n">v_pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span><span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">])</span>
    <span class="n">v_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">])</span>
    
    <span class="n">v_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dP</span><span class="p">)</span>
    <span class="n">v_return</span><span class="p">[</span><span class="n">ind_posi</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_pos</span>
    <span class="n">v_return</span><span class="p">[</span><span class="n">ind_nega</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_neg</span>
    
    <span class="k">return</span> <span class="n">v_return</span>


<span class="k">def</span> <span class="nf">change_node_fn</span><span class="p">(</span><span class="n">z_raw</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">,</span> <span class="n">N_new</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_raw</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">fn_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_return</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">z_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">N_new</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">y_raw</span><span class="p">:</span>
            <span class="n">fn_tmp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">z_raw</span><span class="p">,</span><span class="n">yr</span><span class="p">)</span>
            <span class="n">y_new_tmp</span> <span class="o">=</span> <span class="n">fn_tmp</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
            <span class="n">y_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_new_tmp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">y_raw</span>
        <span class="n">fn_tmp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">z_raw</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="n">z_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">N_new</span><span class="p">)</span>
        <span class="n">y_return</span> <span class="o">=</span> <span class="n">fn_tmp</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">y_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">fn_tmp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">z_raw</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="n">z_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">N_new</span><span class="p">)</span>
        <span class="n">y_return</span> <span class="o">=</span> <span class="n">fn_tmp</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input should be 1d or 2d array.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">y_return</span>

<span class="c1"># %% Column class</span>
<div class="viewcode-block" id="column"><a class="viewcode-back" href="../../simsep.html#pyAPEP.simsep.column">[docs]</a><span class="k">class</span> <span class="nc">column</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to characterize pure-component isotherm data with an analytical model.</span>
<span class="sd">    Data fitting is done during instantiation.</span>
<span class="sd">    </span>
<span class="sd">    Models supported are as follows. Here, :math:`L` is the gas uptake,</span>
<span class="sd">    :math:`P` is pressure (fugacity technically).</span>
<span class="sd">    </span>
<span class="sd">    * Langmuir isotherm model</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        L(P) = M\\frac{KP}{1+KP},</span>
<span class="sd">        </span>
<span class="sd">    * Quadratic isotherm model</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        L(P) = M \\frac{(K_a + 2 K_b P)P}{1+K_aP+K_bP^2}</span>
<span class="sd">        </span>
<span class="sd">    * Brunauer-Emmett-Teller (BET) adsorption isotherm</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        L(P) = M\\frac{K_A P}{(1-K_B P)(1-K_B P+ K_A P)}</span>
<span class="sd">        </span>
<span class="sd">    * Dual-site Langmuir (DSLangmuir) adsorption isotherm</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        L(P) = M_1\\frac{K_1 P}{1+K_1 P} +  M_2\\frac{K_2 P}{1+K_2 P}</span>
<span class="sd">        </span>
<span class="sd">    * Asymptotic approximation to the Temkin Isotherm</span>
<span class="sd">    (see DOI: 10.1039/C3CP55039G)</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        L(P) = M\\frac{KP}{1+KP} + M \\theta (\\frac{KP}{1+KP})^2 (\\frac{KP}{1+KP} -1)</span>
<span class="sd">        </span>
<span class="sd">    * Henry&#39;s law. Only use if your data is linear, and do not necessarily trust</span>
<span class="sd">      IAST results from Henry&#39;s law if the result required an extrapolation</span>
<span class="sd">      of your data; Henry&#39;s law is unrealistic because the adsorption sites</span>
<span class="sd">      will saturate at higher pressures.</span>
<span class="sd">      </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">        L(P) = K_H P</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="column.__init__"><a class="viewcode-back" href="../../simsep.html#pyAPEP.simsep.column.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">A_cross</span><span class="p">,</span> <span class="n">n_component</span><span class="p">,</span> 
                 <span class="n">N_node</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">E_balance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="n">A_cross</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span> <span class="o">=</span> <span class="n">n_component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">N_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Design&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;adsorbent_info&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;gas_prop_info&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;mass_trans_info&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,}</span>
        <span class="k">if</span> <span class="n">E_balance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;thermal_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;boundaryC_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;initialC_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">L</span><span class="o">/</span><span class="p">(</span><span class="n">N_node</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h_arr</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">=</span> <span class="n">h</span>
 
        <span class="c1"># FDM backward, 1st deriv</span>
        <span class="n">d0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">+</span> <span class="n">d1</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="n">d</span>
        
        <span class="c1"># FDM foward, 1st deriv</span>
        <span class="n">d0_fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">d1_fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d_fo</span> <span class="o">=</span> <span class="n">d0_fo</span> <span class="o">+</span> <span class="n">d1_fo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_fo</span>  <span class="o">=</span> <span class="n">d_fo</span>
 
        <span class="c1"># FDM centered, 2nd deriv</span>
        <span class="n">dd0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="n">h_arr</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">dd0</span> <span class="o">+</span> <span class="n">dd1</span> <span class="o">+</span> <span class="n">dd2</span>
        <span class="n">dd</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dd</span> <span class="o">=</span> <span class="n">dd</span></div>
 
<div class="viewcode-block" id="column.__str__"><a class="viewcode-back" href="../../simsep.html#pyAPEP.simsep.column.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">str_return</span> <span class="o">=</span> <span class="s1">&#39;[[Current information included here]] </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">str_return</span> <span class="o">=</span> <span class="n">str_return</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0:16s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">):</span>
                <span class="n">str_return</span> <span class="o">=</span> <span class="n">str_return</span><span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="n">kk</span><span class="p">]:</span>
                <span class="n">str_return</span> <span class="o">=</span> <span class="n">str_return</span> <span class="o">+</span> <span class="s1">&#39;: True</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_return</span> <span class="o">=</span> <span class="n">str_return</span> <span class="o">+</span> <span class="s1">&#39;: False</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">str_return</span></div>
 
 <span class="c1">### Before running the simulations ###</span>

    <span class="k">def</span> <span class="nf">adsorbent_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iso_fn</span><span class="p">,</span> <span class="n">epsi</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">D_particle</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">rho_s</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span><span class="n">P_test_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">T_test_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">273</span><span class="p">,</span><span class="mi">373</span><span class="p">]):</span>
        <span class="n">T_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">T_test_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">T_test_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
        <span class="n">p_test</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">):</span>
            <span class="n">p_tmp</span> <span class="o">=</span> <span class="n">P_test_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">P_test_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P_test_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">p_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_tmp</span><span class="p">)</span>        
        <span class="k">try</span><span class="p">:</span>      
            <span class="n">iso_test</span> <span class="o">=</span> <span class="n">iso_fn</span><span class="p">(</span><span class="n">p_test</span><span class="p">,</span> <span class="n">T_test</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iso_test</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output should be a list/narray including </span><span class="si">{}</span><span class="s1"> narray!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iso</span> <span class="o">=</span> <span class="n">iso_fn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span> <span class="o">=</span> <span class="n">rho_s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span> <span class="o">=</span> <span class="n">epsi</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_D_p</span> <span class="o">=</span><span class="n">D_particle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;adsorbent_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You have problem in iso_fn&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input should be ( [p1_array,p2_array, ...] and T_array )&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output should be a list/narray including </span><span class="si">{}</span><span class="s1"> narray!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">))</span>
        
        
    <span class="k">def</span> <span class="nf">gas_prop_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mass_molar</span><span class="p">,</span> <span class="n">mu_viscosity</span><span class="p">):</span>
        <span class="n">stack_true</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mass_molar</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The input variable should be a list/narray with shape (</span><span class="si">{0:d}</span><span class="s1">, ).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_viscosity</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The input variable should be a list/narray with shape (</span><span class="si">{0:d}</span><span class="s1">, ).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stack_true</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_M_m</span> <span class="o">=</span> <span class="n">Mass_molar</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span> <span class="o">=</span> <span class="n">mu_viscosity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;gas_prop_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">mass_trans_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_mass_transfer</span><span class="p">,</span> <span class="n">a_specific_surf</span><span class="p">,</span> <span class="n">D_dispersion</span> <span class="o">=</span> <span class="mf">1E-8</span><span class="p">):</span>
        <span class="n">stack_true</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">D_dispersion</span><span class="p">):</span>
            <span class="n">D_dispersion</span> <span class="o">=</span> <span class="n">D_dispersion</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_mass_transfer</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">k_mass_transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The input variable should be a list/narray with shape (</span><span class="si">{0:d}</span><span class="s1">, ).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">D_dispersion</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The input variable should be a list/narray with shape (</span><span class="si">{0:d}</span><span class="s1">, ).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stack_true</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span> <span class="o">=</span> <span class="n">k_mass_transfer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span> <span class="o">=</span> <span class="n">a_specific_surf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_D_disp</span> <span class="o">=</span> <span class="n">D_dispersion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;mass_trans_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    
    <span class="k">def</span> <span class="nf">thermal_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dH_adsorption</span><span class="p">,</span>
                     <span class="n">Cp_solid</span><span class="p">,</span> <span class="n">Cp_gas</span><span class="p">,</span> <span class="n">h_heat_transfer</span><span class="p">,</span>
                     <span class="n">k_conduct</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">h_heat_ambient</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">T_ambient</span> <span class="o">=</span> <span class="mf">298.15</span><span class="p">):</span>
        <span class="n">stack_true</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dH_adsorption</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_comp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dH_adsorption should be (</span><span class="si">{0:d}</span><span class="s1">,) list/narray.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_comp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Cp_gas</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_comp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cp_gas should be (</span><span class="si">{0:d}</span><span class="s1">,) list/narray.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_comp</span><span class="p">))</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">h_heat_transfer</span><span class="p">):</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;h_heat_transfer should be scalar.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack_true</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dH</span> <span class="o">=</span> <span class="n">dH_adsorption</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Cp_s</span> <span class="o">=</span> <span class="n">Cp_solid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Cp_g</span> <span class="o">=</span> <span class="n">Cp_gas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h_heat</span> <span class="o">=</span> <span class="n">h_heat_transfer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_k_cond</span> <span class="o">=</span> <span class="n">k_conduct</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h_ambi</span> <span class="o">=</span> <span class="n">h_heat_ambient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_T_ambi</span> <span class="o">=</span> <span class="n">T_ambient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;thermal_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
 
    <span class="k">def</span> <span class="nf">boundaryC_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P_outlet</span><span class="p">,</span>
    <span class="n">P_inlet</span><span class="p">,</span><span class="n">T_inlet</span><span class="p">,</span><span class="n">y_inlet</span><span class="p">,</span> <span class="n">Cv_in</span><span class="o">=</span><span class="mf">1E-1</span><span class="p">,</span><span class="n">Cv_out</span><span class="o">=</span><span class="mf">1E-3</span><span class="p">,</span>
      <span class="n">Q_inlet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assigned_v_option</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
      <span class="n">foward_flow_direction</span> <span class="o">=</span>  <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Q_varying</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Foward&#39;</span>
        <span class="k">if</span> <span class="n">foward_flow_direction</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">A_flip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
                <span class="n">A_flip</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Backward&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span> <span class="o">=</span> <span class="n">A_flip</span>
        <span class="k">if</span> <span class="n">Q_inlet</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assigned_v_option</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">Q_inlet</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">assigned_v_option</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Q_inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_inlet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">f_Q_in</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fn_Q</span> <span class="o">=</span> <span class="n">f_Q_in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Q_varying</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_inlet</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_P_out</span> <span class="o">=</span> <span class="n">P_outlet</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span> <span class="o">=</span> <span class="n">P_inlet</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_T_in</span> <span class="o">=</span> <span class="n">T_inlet</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_y_in</span> <span class="o">=</span> <span class="n">y_inlet</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Q_in</span> <span class="o">=</span> <span class="n">Q_inlet</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Cv_in</span> <span class="o">=</span> <span class="n">Cv_in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Cv_out</span> <span class="o">=</span> <span class="n">Cv_out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_const_v</span> <span class="o">=</span> <span class="n">assigned_v_option</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;boundaryC_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">assigned_v_option</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Assigned velocity option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Assigned velocity option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The inlet composition should be a list/narray with shape (2, ).&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The inlet composition should be a list/narray with shape (2, ).&#39;</span><span class="p">)</span>    
 
    <span class="k">def</span> <span class="nf">initialC_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">P_initial</span><span class="p">,</span> <span class="n">Tg_initial</span><span class="p">,</span><span class="n">Ts_initial</span><span class="p">,</span> <span class="n">y_initial</span><span class="p">,</span><span class="n">q_initial</span><span class="p">):</span>
        <span class="n">stack_true</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_initial</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_initial should be of shape (</span><span class="si">{}</span><span class="s1">,)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_initial</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y_initial should be a list including </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">,) array&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_initial</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_initial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q_initial should be a list/array including </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">,) array&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack_true</span> <span class="o">=</span> <span class="n">stack_true</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">stack_true</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span> <span class="n">P_initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span> <span class="o">=</span> <span class="n">Tg_initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ts_init</span> <span class="o">=</span> <span class="n">Ts_initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span> <span class="o">=</span> <span class="n">y_initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span> <span class="o">=</span> <span class="n">q_initial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;initialC_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>               

<span class="c1">#########################</span>
<span class="c1">##### RUN FUNCTIONS #####</span>
<span class="c1">#########################</span>

<span class="c1">## Run mass &amp; momentum balance equations</span>
    <span class="k">def</span> <span class="nf">run_mamo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span>
        <span class="n">t_max_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="p">),</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
        <span class="n">n_t</span> <span class="o">=</span> <span class="n">t_max_int</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
        <span class="n">n_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span>
        <span class="n">C_sta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_in</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_in</span><span class="o">*</span><span class="mf">1E5</span><span class="p">)</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max_int</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_max_int</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">:</span>
            <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="p">]))</span>
        <span class="c1">#print(C1_sta)</span>

        <span class="c1"># other parmeters</span>
        <span class="n">epsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
        <span class="n">rho_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span>

        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="k">def</span> <span class="nf">massmomebal</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
            <span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">])</span>
                <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">])</span>
 
            <span class="c1"># Derivatives</span>
            <span class="n">dC</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ddC</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">C_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">P_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">P_part</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">ddC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">P_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
                <span class="n">C_ov</span> <span class="o">=</span> <span class="n">C_ov</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">P_ov</span> <span class="o">=</span> <span class="n">P_ov</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T</span>
                <span class="n">Mu</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">Mu</span><span class="o">/</span><span class="n">C_ov</span>

            <span class="c1"># Ergun equation</span>
            <span class="n">v</span><span class="p">,</span><span class="n">dv</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
            
            <span class="c1"># Solid phase</span>
            <span class="n">qsta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
            <span class="n">dqdt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                    <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>
                    <span class="n">dqdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                    <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>
                    <span class="n">dqdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
            <span class="c1"># Valve equations (v_in and v_out)</span>
            <span class="c1">#P_in = (C1_sta + C2_sta)*R_gas*T_gas</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_const_v</span><span class="p">:</span>
                <span class="n">v_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_in</span><span class="o">/</span><span class="n">epsi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_in</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cv_in</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span> <span class="o">-</span> <span class="n">P_ov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
            <span class="n">v_out</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cv_out</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P_out</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
            
            <span class="n">D_dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D_disp</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span>
            <span class="c1"># Gas phase</span>
            <span class="n">dCdt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">dC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv</span> <span class="o">+</span> <span class="n">D_dis</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="c1">#dCdt_tmp[0] = +(v_in*C_sta[ii] - v[1]*C[ii][0])/h - (1-epsi)/epsi*rho_s*dqdt[ii][0]</span>
                <span class="c1">#dCdt_tmp[-1]= +(v[-1]*C[ii][-2]- v_out*C[ii][-1])/h - (1-epsi)/epsi*rho_s*dqdt[ii][-1]</span>
                <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_in</span><span class="o">*</span><span class="p">(</span><span class="n">C_sta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_out</span><span class="o">+</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dCdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
 
            <span class="n">dydt_tmp</span> <span class="o">=</span> <span class="n">dCdt</span><span class="o">+</span><span class="n">dqdt</span>
            <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dydt</span>
        
        <span class="n">C_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span><span class="o">*</span><span class="mf">1E5</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span>
            <span class="n">C_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_tmp</span><span class="p">)</span>
            <span class="n">q_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">q_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tmp</span><span class="p">)</span>
 
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">C_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@C_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        
        <span class="n">y0_tmp</span> <span class="o">=</span> <span class="n">C_init</span> <span class="o">+</span> <span class="n">q_init</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y0_tmp</span><span class="p">)</span>
        
        <span class="c1">#RUN</span>
        <span class="n">y_result</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomebal</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">t_dom</span><span class="p">,)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">mat_tmp</span> <span class="o">=</span> <span class="n">y_result</span><span class="p">[:,</span> <span class="n">ii</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>
                <span class="n">y_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat_tmp</span><span class="nd">@self</span><span class="o">.</span><span class="n">_A_flip</span><span class="p">)</span>
            <span class="n">y_flip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_tmp</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y_result</span> <span class="o">=</span> <span class="n">y_flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span><span class="nd">@np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>       
        <span class="k">return</span> <span class="n">y_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span>

<span class="c1">## Run mass &amp; momentum &amp; energy balance equations</span>

    <span class="k">def</span> <span class="nf">run_mamoen_alt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">t_max_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
        <span class="n">n_t</span> <span class="o">=</span> <span class="n">t_max_int</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
        <span class="n">n_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span>
        
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max_int</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_max_int</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">:</span>
            <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="p">]))</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span>
        <span class="n">epsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
        <span class="n">a_surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>

        <span class="c1"># Mass</span>
        <span class="n">D_dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D_disp</span>
        <span class="n">k_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span>

        <span class="c1"># Heat</span>
        <span class="n">dH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dH</span>
        <span class="n">Cpg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cp_g</span>
        <span class="n">Cps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cp_s</span>

        <span class="n">h_heat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_heat</span>
        <span class="n">h_ambi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_ambi</span>
        <span class="n">T_ambi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T_ambi</span>

        <span class="c1"># other parmeters</span>
        <span class="n">rho_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span>
        <span class="n">D_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

        <span class="n">C_sta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Cov_Cpg_in</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_in</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_in</span><span class="o">*</span><span class="mf">1E5</span><span class="p">)</span>
            <span class="n">Cov_Cpg_in</span> <span class="o">=</span> <span class="n">Cov_Cpg_in</span> <span class="o">+</span> <span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C_sta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">massmomeenerbal_alt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
            <span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">])</span>
                <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">])</span>
            <span class="n">Tg</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">N</span> <span class="p">]</span>
            <span class="n">Ts</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">N</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span> <span class="p">]</span>

 
            <span class="c1"># Derivatives</span>
            <span class="n">dC</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ddC</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">C_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">P_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">P_part</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="c1">#T = self._Tg_init</span>
            <span class="c1"># Temperature gradient:</span>
            <span class="n">dTg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg</span>
            <span class="n">ddTs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts</span>

            <span class="c1"># Concentration gradient</span>
            <span class="c1"># Pressure (overall&amp;partial)</span>
            <span class="c1"># Viscosity</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">ddC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">P_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
                <span class="n">C_ov</span> <span class="o">=</span> <span class="n">C_ov</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">P_ov</span> <span class="o">=</span> <span class="n">P_ov</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg</span>
                <span class="n">Mu</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">Mu</span><span class="o">/</span><span class="n">C_ov</span>

            <span class="c1"># Ergun equation</span>
            <span class="n">v</span><span class="p">,</span><span class="n">dv</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">Tg</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
            
            <span class="c1"># Solid phase concentration</span>
            <span class="n">qsta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part</span><span class="p">,</span> <span class="n">Tg</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
            <span class="n">dqdt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                    <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>
                    <span class="n">dqdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                    <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>
                    <span class="n">dqdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
            <span class="c1"># Valve equations (v_in and v_out)</span>
            <span class="c1">#P_in = (C1_sta + C2_sta)*R_gas*T_gas</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_const_v</span><span class="p">:</span>
                <span class="n">v_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_in</span><span class="o">/</span><span class="n">epsi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_in</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cv_in</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span> <span class="o">-</span> <span class="n">P_ov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
            <span class="n">v_out</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cv_out</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P_out</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
            
            <span class="c1"># Gas phase concentration</span>
            <span class="n">dCdt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">dC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv</span> <span class="o">+</span> <span class="n">D_dis</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="c1">#dCdt_tmp[0] = +(v_in*C_sta[ii] - v[1]*C[ii][0])/h - (1-epsi)/epsi*rho_s*dqdt[ii][0]    </span>
                <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="n">v_in</span><span class="o">*</span><span class="p">(</span><span class="n">C_sta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_out</span><span class="o">+</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dCdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
            <span class="c1"># Temperature (gas)</span>
            <span class="n">Cov_Cpg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">Cov_Cpg</span> <span class="o">=</span> <span class="n">Cov_Cpg</span> <span class="o">+</span> <span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dTgdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">dTg</span> <span class="o">+</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dTgdt</span> <span class="o">=</span> <span class="n">dTgdt</span> <span class="o">-</span> <span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg</span><span class="o">*</span><span class="n">D_dis</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span>
                <span class="n">dTgdt</span> <span class="o">=</span> <span class="n">dTgdt</span> <span class="o">+</span> <span class="n">Tg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span>
                <span class="n">dTgdt</span> <span class="o">=</span> <span class="n">dTgdt</span> <span class="o">+</span> <span class="n">h_ambi</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi</span><span class="o">/</span><span class="n">D_col</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg</span>

            <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_in</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_in</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h</span>
            <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#dTgdt[-1] = dTgdt[-1] + (v[-1]*Tg[-2]*Cov_Cpg[-2]/Cov_Cpg[-1] - v_out*Tg[-1])/h</span>
            <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">v_out</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dTsdt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs</span><span class="o">+</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg</span><span class="o">-</span><span class="n">Ts</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span><span class="o">/</span><span class="n">Cps</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dTsdt</span> <span class="o">=</span> <span class="n">dTsdt</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps</span>
            
            <span class="n">dydt_tmp</span> <span class="o">=</span> <span class="n">dCdt</span><span class="o">+</span><span class="n">dqdt</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt</span><span class="p">]</span>
            <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dydt</span>
        
        <span class="n">C_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span><span class="o">*</span><span class="mf">1E5</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span>
            <span class="n">C_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_tmp</span><span class="p">)</span>
            <span class="n">q_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">q_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tmp</span><span class="p">)</span>
 
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">C_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@C_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">y0_tmp</span> <span class="o">=</span> <span class="n">C_init</span> <span class="o">+</span> <span class="n">q_init</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@self</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@self</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y0_tmp</span> <span class="o">=</span> <span class="n">C_init</span> <span class="o">+</span> <span class="n">q_init</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y0_tmp</span><span class="p">)</span>
        
        <span class="c1">#RUN</span>
        <span class="n">y_result</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomeenerbal_alt</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">t_dom</span><span class="p">,)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">mat_tmp</span> <span class="o">=</span> <span class="n">y_result</span><span class="p">[:,</span> <span class="n">ii</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>
                <span class="n">y_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat_tmp</span><span class="nd">@self</span><span class="o">.</span><span class="n">_A_flip</span><span class="p">)</span>
            <span class="n">y_flip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_tmp</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y_result</span> <span class="o">=</span> <span class="n">y_flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_result</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>       
        <span class="k">return</span> <span class="n">y_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span>



    <span class="k">def</span> <span class="nf">run_mamoen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">t_max_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
        <span class="n">n_t</span> <span class="o">=</span> <span class="n">t_max_int</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
        <span class="n">n_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span>
        
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max_int</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_max_int</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">:</span>
            <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="p">]))</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h</span>
        <span class="n">epsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
        <span class="n">a_surf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>

        <span class="c1"># Mass</span>
        <span class="n">D_dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D_disp</span>
        <span class="n">k_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span>

        <span class="c1"># Heat</span>
        <span class="n">dH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dH</span>
        <span class="n">Cpg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cp_g</span>
        <span class="n">Cps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cp_s</span>

        <span class="n">h_heat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_heat</span>
        <span class="n">h_ambi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_ambi</span>
        <span class="n">T_ambi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T_ambi</span>

        <span class="c1"># other parmeters</span>
        <span class="n">rho_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span>
        <span class="n">D_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

        <span class="n">C_sta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Cov_Cpg_in</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y_in</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_in</span><span class="o">*</span><span class="mf">1E5</span><span class="p">)</span>
            <span class="n">Cov_Cpg_in</span> <span class="o">=</span> <span class="n">Cov_Cpg_in</span> <span class="o">+</span> <span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C_sta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">massmomeenerbal</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
            <span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">])</span>
                <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">])</span>
            <span class="n">Tg</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">N</span> <span class="p">]</span>
            <span class="n">Ts</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="n">N</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span> <span class="p">]</span>

 
            <span class="c1"># Derivatives</span>
            <span class="n">dC</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ddC</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">C_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">P_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">P_part</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="c1">#T = self._Tg_init</span>
            <span class="c1"># Temperature gradient:</span>
            <span class="n">dTg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg</span>
            <span class="n">ddTs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts</span>

            <span class="c1"># Concentration gradient</span>
            <span class="c1"># Pressure (overall&amp;partial)</span>
            <span class="c1"># Viscosity</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">ddC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">P_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
                <span class="n">C_ov</span> <span class="o">=</span> <span class="n">C_ov</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">P_ov</span> <span class="o">=</span> <span class="n">P_ov</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg</span>
                <span class="n">Mu</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">Mu</span><span class="o">/</span><span class="n">C_ov</span>

            <span class="c1"># Ergun equation</span>
            <span class="n">v</span><span class="p">,</span><span class="n">dv</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">Tg</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
            
            <span class="c1"># Solid phase concentration</span>
            <span class="n">qsta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part</span><span class="p">,</span> <span class="n">Tg</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
            <span class="n">dqdt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                    <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>
                    <span class="n">dqdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                    <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_mtc</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_a_surf</span>
                    <span class="n">dqdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
            <span class="c1"># Valve equations (v_in and v_out)</span>
            <span class="c1">#P_in = (C1_sta + C2_sta)*R_gas*T_gas</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_const_v</span><span class="p">:</span>
                <span class="n">v_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_in</span><span class="o">/</span><span class="n">epsi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_in</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cv_in</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span> <span class="o">-</span> <span class="n">P_ov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
            <span class="n">v_out</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cv_out</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P_out</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
            
            <span class="c1"># Gas phase concentration</span>
            <span class="n">dCdt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">dC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv</span> <span class="o">+</span> <span class="n">D_dis</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in</span><span class="o">*</span><span class="n">C_sta</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>    
                <span class="c1">#dCdt_tmp[0] = +(v_in*C_sta[ii] - v[1]*C[ii][0])/h - (1-epsi)/epsi*rho_s*dqdt[ii][0]</span>
                <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">v_out</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">rho_s</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dCdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
            <span class="c1"># Temperature (gas)</span>
            <span class="n">Cov_Cpg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">Cov_Cpg</span> <span class="o">=</span> <span class="n">Cov_Cpg</span> <span class="o">+</span> <span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dTgdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">dTg</span> <span class="o">+</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dTgdt</span> <span class="o">=</span> <span class="n">dTgdt</span> <span class="o">-</span> <span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg</span><span class="o">*</span><span class="n">D_dis</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span>
                <span class="n">dTgdt</span> <span class="o">=</span> <span class="n">dTgdt</span> <span class="o">+</span> <span class="n">Tg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span>
                <span class="n">dTgdt</span> <span class="o">=</span> <span class="n">dTgdt</span> <span class="o">+</span> <span class="n">h_ambi</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi</span><span class="o">/</span><span class="n">D_col</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg</span>

            <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v_in</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_in</span><span class="o">*</span><span class="n">Cov_Cpg_in</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h</span>
            <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="n">epsi</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#dTgdt[-1] = dTgdt[-1] + (v[-1]*Tg[-2]*Cov_Cpg[-2]/Cov_Cpg[-1] - v_out*Tg[-1])/h</span>
            <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_out</span><span class="o">*</span><span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dTsdt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs</span><span class="o">+</span> <span class="n">h_heat</span><span class="o">*</span><span class="n">a_surf</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg</span><span class="o">-</span><span class="n">Ts</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_rho_s</span><span class="o">/</span><span class="n">Cps</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dTsdt</span> <span class="o">=</span> <span class="n">dTsdt</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps</span>
            
            <span class="n">dydt_tmp</span> <span class="o">=</span> <span class="n">dCdt</span><span class="o">+</span><span class="n">dqdt</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt</span><span class="p">]</span>
            <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dydt</span>
        
        <span class="n">C_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span><span class="o">*</span><span class="mf">1E5</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span>
            <span class="n">C_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_tmp</span><span class="p">)</span>
            <span class="n">q_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">q_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tmp</span><span class="p">)</span>
 
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">C_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@C_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">y0_tmp</span> <span class="o">=</span> <span class="n">C_init</span> <span class="o">+</span> <span class="n">q_init</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@self</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_A_flip</span><span class="nd">@self</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y0_tmp</span> <span class="o">=</span> <span class="n">C_init</span> <span class="o">+</span> <span class="n">q_init</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y0_tmp</span><span class="p">)</span>
        
        <span class="c1">#RUN</span>
        <span class="n">y_result</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomeenerbal</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">t_dom</span><span class="p">,)</span>
        <span class="n">C_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_sum</span> <span class="o">=</span> <span class="n">C_sum</span> <span class="o">+</span> <span class="n">y_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">C_sum</span>  <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">y_result</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_mamoen_alt</span><span class="p">(</span><span class="n">t_max</span><span class="p">,</span><span class="n">n_sec</span><span class="p">)</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_result</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">y_result</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">mat_tmp</span> <span class="o">=</span> <span class="n">y_result</span><span class="p">[:,</span> <span class="n">ii</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>
                <span class="n">y_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat_tmp</span><span class="nd">@self</span><span class="o">.</span><span class="n">_A_flip</span><span class="p">)</span>
            <span class="n">y_flip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y_tmp</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y_result</span> <span class="o">=</span> <span class="n">y_flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_result</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">N</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>       
        <span class="k">return</span> <span class="n">y_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span>


<span class="c1">## Functions for after-run processing</span>
    <span class="k">def</span> <span class="nf">next_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_init</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="n">y_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">P_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">):</span>
            <span class="n">C_tmp</span> <span class="o">=</span> <span class="n">y_end</span><span class="p">[</span><span class="n">cc</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">cc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>
            <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_tmp</span><span class="p">)</span>
            <span class="n">C_ov</span> <span class="o">=</span> <span class="n">C_ov</span> <span class="o">+</span> <span class="n">C_tmp</span>
            <span class="n">P_ov</span> <span class="o">=</span> <span class="n">P_ov</span> <span class="o">+</span> <span class="n">C_tmp</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">/</span><span class="mf">1E5</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">):</span>
            <span class="n">q_tmp</span> <span class="o">=</span> <span class="n">y_end</span><span class="p">[</span><span class="n">cc</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">cc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">C_ov</span>
            <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tmp</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_tmp</span><span class="p">)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;thermal_info&#39;</span><span class="p">]:</span>
                <span class="n">Tg_init</span> <span class="o">=</span> <span class="n">y_end</span><span class="p">[</span><span class="n">cc</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">cc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>    
                <span class="n">Ts_init</span> <span class="o">=</span> <span class="n">y_end</span><span class="p">[(</span><span class="n">cc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">cc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span>    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Tg_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>    
                <span class="n">Ts_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>    
        <span class="k">except</span><span class="p">:</span>
            <span class="n">Tg_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">Ts_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">P_init</span> <span class="o">=</span> <span class="n">P_ov</span>
        <span class="n">y_init</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">q_init</span> <span class="o">=</span> <span class="n">q</span>

        <span class="k">if</span> <span class="n">change_init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span> <span class="n">P_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span> <span class="n">Tg_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ts_init</span> <span class="o">=</span> <span class="n">Ts_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span> <span class="o">=</span> <span class="n">y_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span> <span class="o">=</span> <span class="n">q_init</span> 
        <span class="k">return</span> <span class="n">P_init</span><span class="p">,</span> <span class="n">Tg_init</span><span class="p">,</span> <span class="n">Ts_init</span> <span class="p">,</span> <span class="n">y_init</span><span class="p">,</span> <span class="n">q_init</span>
    
    <span class="k">def</span> <span class="nf">change_init_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_new</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">==</span> <span class="n">N_new</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No change in # of node.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span>
            <span class="n">P_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span>
            <span class="n">Tg_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span>
            <span class="n">Ts_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ts_init</span>
            <span class="n">y_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span>
            <span class="n">q_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span>
        <span class="n">P_new</span> <span class="o">=</span> <span class="n">change_node_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">P_init</span><span class="p">,</span> <span class="n">N_new</span><span class="p">)</span>
        <span class="n">Tg_new</span> <span class="o">=</span> <span class="n">change_node_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">Tg_init</span><span class="p">,</span> <span class="n">N_new</span><span class="p">)</span>
        <span class="n">Ts_new</span> <span class="o">=</span> <span class="n">change_node_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">Ts_init</span><span class="p">,</span> <span class="n">N_new</span><span class="p">)</span>
        <span class="n">y_new</span> <span class="o">=</span> <span class="n">change_node_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y_init</span><span class="p">,</span> <span class="n">N_new</span><span class="p">)</span>
        <span class="n">q_new</span> <span class="o">=</span> <span class="n">change_node_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">q_init</span><span class="p">,</span> <span class="n">N_new</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">N_new</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span> <span class="n">P_new</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_Tg_init</span> <span class="o">=</span> <span class="n">Tg_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ts_init</span> <span class="o">=</span> <span class="n">Ts_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_init</span> <span class="o">=</span> <span class="n">y_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q_init</span> <span class="o">=</span> <span class="n">q_new</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N_new</span>
        <span class="n">h_arr</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">N_new</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N_new</span><span class="p">)</span>
        <span class="c1"># FDM backward, 1st deriv</span>
        <span class="n">d0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">+</span> <span class="n">d1</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="n">d</span>
        
        <span class="c1"># FDM foward, 1st deriv</span>
        <span class="n">d0_fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">d1_fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d_fo</span> <span class="o">=</span> <span class="n">d0_fo</span> <span class="o">+</span> <span class="n">d1_fo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_fo</span>  <span class="o">=</span> <span class="n">d_fo</span>
 
        <span class="c1"># FDM centered, 2nd deriv</span>
        <span class="n">dd0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="n">h_arr</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">h_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">dd0</span> <span class="o">+</span> <span class="n">dd1</span> <span class="o">+</span> <span class="n">dd2</span>
        <span class="n">dd</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dd</span> <span class="o">=</span> <span class="n">dd</span>

    <span class="k">def</span> <span class="nf">Q_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw_graph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="n">Cv_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cv_out</span>
            <span class="n">Cv_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cv_in</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Cv_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cv_in</span>
            <span class="n">Cv_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cv_out</span>
            
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
        <span class="n">P_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span>
        <span class="n">P_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">):</span>
            <span class="n">P_0</span> <span class="o">=</span> <span class="n">P_0</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:,</span><span class="n">N</span><span class="o">*</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span>
            <span class="n">P_L</span> <span class="o">=</span> <span class="n">P_L</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:,</span><span class="n">N</span><span class="o">*</span><span class="n">ii</span><span class="o">+</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Flow direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Backward&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Assigned velocity option&#39;</span><span class="p">]:</span>
                <span class="n">v_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_in</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_L</span> <span class="o">=</span> <span class="n">Cv_L</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span> <span class="o">-</span> <span class="n">P_L</span><span class="p">)</span>
            <span class="n">v_0</span> <span class="o">=</span> <span class="n">Cv_0</span><span class="o">*</span><span class="p">(</span><span class="n">P_0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P_out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span><span class="p">[</span><span class="s1">&#39;Assigned velocity option&#39;</span><span class="p">]:</span>
                <span class="n">v_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_in</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_0</span> <span class="o">=</span> <span class="n">Cv_0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_P_in</span> <span class="o">-</span> <span class="n">P_0</span><span class="p">)</span>
            <span class="n">v_L</span> <span class="o">=</span> <span class="n">Cv_L</span><span class="o">*</span><span class="p">(</span><span class="n">P_L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P_out</span><span class="p">)</span>
        <span class="n">Q_0</span> <span class="o">=</span> <span class="n">v_0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
        <span class="n">Q_0</span><span class="p">[</span><span class="n">Q_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Q_L</span> <span class="o">=</span> <span class="n">v_L</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsi</span>
        <span class="n">Q_L</span><span class="p">[</span><span class="n">Q_L</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
 
        <span class="k">if</span> <span class="n">draw_graph</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="n">Q_0</span><span class="p">,</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Q at z = 0&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="n">Q_L</span><span class="p">,</span> 
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Q at z = L&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (sec)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;volumetric flowrate (m$^</span><span class="si">{3}</span><span class="s1">$/sec)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Q_0</span><span class="p">,</span> <span class="n">Q_L</span>
    
    <span class="k">def</span> <span class="nf">breakthrough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draw_graph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="n">n_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span>
        <span class="n">C_end</span> <span class="o">=</span><span class="p">[]</span>
        <span class="n">C_ov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">Cend_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[:,(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">C_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cend_tmp</span><span class="p">)</span>
            <span class="n">C_ov</span> <span class="o">=</span> <span class="n">C_ov</span> <span class="o">+</span> <span class="n">Cend_tmp</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fn_y</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">C_end</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">C_ov</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_tmp</span><span class="p">)</span>
            <span class="n">fn_tmp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="n">y_tmp</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span> <span class="p">)</span> 
            <span class="n">fn_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn_tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw_graph</span><span class="p">:</span>
            <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">1001</span><span class="p">)</span>
            <span class="n">y_again</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">y_ag_tmp</span> <span class="o">=</span> <span class="n">fn_y</span><span class="p">[</span><span class="n">ii</span><span class="p">](</span><span class="n">t_dom</span><span class="p">)</span>
                <span class="n">y_again</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_ag_tmp</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_dom</span><span class="p">,</span> <span class="n">y_ag_tmp</span><span class="p">,</span>
                         <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Component</span><span class="si">{0:2d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                         <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>            
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (sec)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mole fraction (mol/mol)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">fn_y</span>
 
    <span class="k">def</span> <span class="nf">Graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">every_n_sec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> 
              <span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">yaxis_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
              <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
              <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">85</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="n">one_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_sec</span>
        <span class="n">n_show</span> <span class="o">=</span> <span class="n">one_sec</span><span class="o">*</span><span class="n">every_n_sec</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
        <span class="n">lstyle</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s1">&#39;-.&#39;</span><span class="p">,(</span><span class="mi">0</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span><span class="s1">&#39;:&#39;</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
        <span class="n">cc</span><span class="o">=</span> <span class="mi">0</span>
        <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">),</span> <span class="n">n_show</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span><span class="o">-</span><span class="n">n_show</span><span class="p">:</span>
                <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">index</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">],</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">lcolor</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">lstyle</span><span class="p">[</span><span class="n">cc</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">lstyle</span><span class="p">)],</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;t = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span><span class="n">bbox_to_anchor</span> <span class="o">=</span> <span class="n">loc</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z-domain (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yaxis_label</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylab</span> <span class="o">=</span> <span class="s1">&#39;Variable index = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yaxis_label</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">13</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">13</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        
    <span class="k">def</span> <span class="nf">Graph_P</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">every_n_sec</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">yaxis_label</span> <span class="o">=</span> <span class="s1">&#39;Pressure (bar)&#39;</span><span class="p">,</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">85</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
        <span class="n">one_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_sec</span>
        <span class="n">n_show</span> <span class="o">=</span> <span class="n">one_sec</span><span class="o">*</span><span class="n">every_n_sec</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
        <span class="n">lstyle</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s1">&#39;-.&#39;</span><span class="p">,(</span><span class="mi">0</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span><span class="s1">&#39;:&#39;</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[:,(</span><span class="n">ii</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Tg_res</span><span class="o">/</span><span class="mf">1E5</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">)</span>
        <span class="n">cc</span><span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">),</span> <span class="n">n_show</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span><span class="o">-</span><span class="n">n_show</span><span class="p">:</span>
                <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lcolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">lcolor</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">lstyle</span><span class="p">[</span><span class="n">cc</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">lstyle</span><span class="p">)],</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;t = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">bbox_to_anchor</span> <span class="o">=</span> <span class="n">loc</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z-domain (m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yaxis_label</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">13</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">13</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>    
    <span class="c1">## Copy the         </span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="n">self_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self_new</span></div>




<span class="k">def</span> <span class="nf">step_P_eq_alt1</span><span class="p">(</span><span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span>
<span class="n">n_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Cv_btw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">valve_select</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="c1"># in minute</span>
    <span class="n">P_sum1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column1</span><span class="o">.</span><span class="n">_P_init</span><span class="p">)</span>
    <span class="n">P_sum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column2</span><span class="o">.</span><span class="n">_P_init</span><span class="p">)</span>
    <span class="n">P_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_sum1</span><span class="o">+</span><span class="n">P_sum2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">T_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column1</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column2</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">P_sum1</span> <span class="o">&gt;</span> <span class="n">P_sum2</span><span class="p">:</span>
        <span class="n">c1_tmp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c2_tmp</span> <span class="o">=</span> <span class="n">column2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valve_select</span><span class="p">)</span>
        <span class="n">switch_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c1_tmp</span> <span class="o">=</span> <span class="n">column2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c2_tmp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">valve_select</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valve_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">switch_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">val_sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">A_flip1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
            <span class="n">A_flip1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="nd">@A_flip1</span>
        <span class="n">flip1_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flip1_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">val_sel</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">A_flip2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
            <span class="n">A_flip2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="nd">@A_flip2</span>
        <span class="n">flip2_later</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flip2_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">t_max_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="p">))</span>
    <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">n_t</span> <span class="o">=</span> <span class="n">t_max_int</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
    <span class="n">n_comp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">_n_comp</span>
    
    <span class="c1"># Target pressure</span>
    <span class="n">C_sta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_comp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C_sta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P_mean</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">T_mean</span><span class="o">*</span><span class="mf">1E5</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">C_sta1</span><span class="p">)</span>

    <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max_int</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span>
    <span class="n">column1</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">column2</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="k">if</span> <span class="n">t_max_int</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">:</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="p">]))</span>

    <span class="n">N1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h</span>
    <span class="n">epsi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_epsi</span>
    <span class="n">epsi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_epsi</span>

    <span class="n">a_surf1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_a_surf</span>
    <span class="n">a_surf2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_a_surf</span>
    <span class="c1"># Mass</span>
    <span class="n">D_dis1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_disp</span>
    <span class="n">D_dis2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_disp</span>

    <span class="n">k_mass1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_k_mtc</span>
    <span class="n">k_mass2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_k_mtc</span>

    <span class="c1"># Heat</span>
    <span class="n">dH1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dH</span>
    <span class="n">dH2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dH</span>
    <span class="n">Cpg1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Cp_g</span>
    <span class="n">Cpg2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Cp_g</span>
    
    <span class="n">Cps1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Cp_s</span>
    <span class="n">Cps2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Cp_s</span>

    <span class="n">h_heat1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h_heat</span>
    <span class="n">h_heat2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h_heat</span>

    <span class="n">h_ambi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h_ambi</span>
    <span class="n">h_ambi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h_ambi</span>

    <span class="n">T_ambi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_T_ambi</span>
    <span class="n">T_ambi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_T_ambi</span>

    <span class="c1"># other parmeters</span>
    <span class="n">rho_s1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_rho_s</span>
    <span class="n">rho_s2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_rho_s</span>
    <span class="n">D_col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">D_col2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

    <span class="n">n_var_tot1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_n_comp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">n_var_tot2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_n_comp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    
    <span class="c1"># Initial conditions</span>
    <span class="n">y01</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y02</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C1_tmp</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mf">1E5</span>    <span class="c1"># in (mol/m^3)</span>
        <span class="n">C2_tmp</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mf">1E5</span>    <span class="c1"># in (mol/m^3)</span>
        <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1_tmp</span><span class="p">)</span>
        <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2_tmp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
    <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span>
    <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span>
    <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">)</span>
    <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">)</span>
    <span class="n">y01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y01</span><span class="p">)</span>
    <span class="n">y02</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y02</span><span class="p">)</span>
    <span class="n">y0_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y01</span><span class="p">,</span><span class="n">y02</span><span class="p">])</span>
    
    <span class="c1"># ODE function (Gas only)</span>
    <span class="k">def</span> <span class="nf">massmomeenbal_eq_gasonly</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">N1</span><span class="o">*</span><span class="n">n_comp</span><span class="p">]</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">N1</span><span class="o">*</span><span class="n">n_comp</span><span class="p">:]</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">C2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
            
        <span class="c1"># Derivatives</span>
        <span class="n">dC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_part1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P_part2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="c1">#T = self._Tg_init</span>
        <span class="c1"># Temperature gradient:</span>
        
        <span class="c1"># Concentration gradient</span>
        <span class="c1"># Pressure (overall&amp;partial)</span>
        <span class="c1"># Viscosity</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">dC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">P_part1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T_mean</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">P_part2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T_mean</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">C_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">C_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">P_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T_mean</span>
            <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">P_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">T_mean</span>
            <span class="n">Mu1</span> <span class="o">=</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu2</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">Mu1</span><span class="o">/</span><span class="n">C_ov1</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">Mu2</span><span class="o">/</span><span class="n">C_ov2</span>

        <span class="c1"># Ergun equation</span>
        <span class="n">v1</span><span class="p">,</span><span class="n">dv1</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span><span class="n">T_mean</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi1</span><span class="p">,</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N1</span><span class="p">)</span>
        <span class="n">v2</span><span class="p">,</span><span class="n">dv2</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span><span class="n">T_mean</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi2</span><span class="p">,</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N2</span><span class="p">)</span>
        
        <span class="c1"># Valve equations (v_in and v_out)</span>
        <span class="n">v_in1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_out2</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">v_out1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
        <span class="n">v_in2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
        
        <span class="c1"># Gas phase concentration</span>
        <span class="n">dCdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dCdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv1</span> <span class="o">+</span> <span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="c1">#dCdt_tmp[0] = +(v_in1*0 - v1[1]*C1[ii][0])/h1 - (1-epsi1)/epsi1*rho_s1*dqdt1[ii][0]               ######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">C_sta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>               <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">v_out1</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>        <span class="c1">######BOUNDARY C######## (KEY PROBLEM)</span>
            <span class="n">dCdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
        <span class="n">inout_ratio_mass</span><span class="o">=</span><span class="n">epsi1</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv2</span> <span class="o">+</span> <span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">inout_ratio_mass</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span> <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">v_out2</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span>                <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>

        <span class="c1"># Temperature (gas)</span>
        <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span> <span class="o">+</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">Cov_Cpg2</span> <span class="o">+</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="n">dydt_tmp1</span> <span class="o">=</span> <span class="n">dCdt1</span>
        <span class="n">dydt_tmp2</span> <span class="o">=</span> <span class="n">dCdt2</span>
        <span class="n">dydt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp1</span><span class="p">)</span>
        <span class="n">dydt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp2</span><span class="p">)</span>
        <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dydt1</span><span class="p">,</span><span class="n">dydt2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dydt</span>

    <span class="c1"># ODE function (Gas and Solid)</span>
    <span class="k">def</span> <span class="nf">massmomeenbal_eq</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">n_var_tot1</span><span class="p">]</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n_var_tot1</span><span class="p">:]</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">C2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
            <span class="n">q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">q2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
        <span class="n">Tg1</span> <span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">N1</span> <span class="p">]</span>
        <span class="n">Tg2</span> <span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N2</span> <span class="p">]</span>
        <span class="n">Ts1</span> <span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">N1</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">]</span>
        <span class="n">Ts2</span> <span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N2</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">]</span>

        <span class="c1"># Derivatives</span>
        <span class="n">dC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_part1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P_part2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="c1">#T = self._Tg_init</span>
        <span class="c1"># Temperature gradient:</span>
        <span class="n">dTg1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg1</span>
        <span class="n">dTg2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg2</span>
        <span class="n">ddTs1</span> <span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts1</span>
        <span class="n">ddTs2</span> <span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts2</span>

        <span class="c1"># Concentration gradient</span>
        <span class="c1"># Pressure (overall&amp;partial)</span>
        <span class="c1"># Viscosity</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">dC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">P_part1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg1</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">P_part2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg2</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">C_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">C_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">P_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg1</span>
            <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">P_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg2</span>
            <span class="n">Mu1</span> <span class="o">=</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu2</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">Mu1</span><span class="o">/</span><span class="n">C_ov1</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">Mu2</span><span class="o">/</span><span class="n">C_ov2</span>

        <span class="c1"># Ergun equation</span>
        <span class="n">v1</span><span class="p">,</span><span class="n">dv1</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span><span class="n">Tg1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi1</span><span class="p">,</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N1</span><span class="p">)</span>
        <span class="n">v2</span><span class="p">,</span><span class="n">dv2</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span><span class="n">Tg2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi2</span><span class="p">,</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N2</span><span class="p">)</span>
        
        <span class="c1"># Solid phase concentration</span>
        <span class="n">qsta1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part1</span><span class="p">,</span> <span class="n">Tg1</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
        <span class="n">qsta2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part2</span><span class="p">,</span> <span class="n">Tg2</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
        <span class="n">dqdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dqdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf1</span>
                <span class="n">dqdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf1</span> <span class="o">+</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">a_surf1</span>
                <span class="n">dqdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf2</span>
                <span class="n">dqdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf2</span> <span class="o">+</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">a_surf2</span>
                <span class="n">dqdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>        

        <span class="c1"># Valve equations (v_in and v_out)</span>
        <span class="n">v_in1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_out2</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">v_out1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
        <span class="n">v_in2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
        
        <span class="c1"># Gas phase concentration</span>
        <span class="n">dCdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dCdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv1</span> <span class="o">+</span> <span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="c1">#dCdt_tmp[0] = +(v_in1*0 - v1[1]*C1[ii][0])/h1 - (1-epsi1)/epsi1*rho_s1*dqdt1[ii][0]               ######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">C_sta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>               <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_out1</span><span class="o">+</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">######BOUNDARY C######## (KEY PROBLEM)</span>
            <span class="n">dCdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
        <span class="n">inout_ratio_mass</span><span class="o">=</span><span class="n">epsi1</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv2</span> <span class="o">+</span> <span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">inout_ratio_mass</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">v_out2</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>

        <span class="c1"># Temperature (gas)</span>
        <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span> <span class="o">+</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">Cov_Cpg2</span> <span class="o">+</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dTgdt1</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dTg1</span> <span class="o">+</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
        <span class="n">dTgdt2</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dTg2</span> <span class="o">+</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="c1"># column 1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">-</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg1</span><span class="o">*</span><span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">+</span> <span class="n">Tg1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">+</span> <span class="n">h_ambi1</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi1</span><span class="o">/</span><span class="n">D_col1</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi1</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="c1"># column 2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">-</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="o">*</span><span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">+</span> <span class="n">Tg2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">+</span> <span class="n">h_ambi2</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">D_col2</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi2</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span>

        <span class="c1"># column 1 dTgdt</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_in1</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>                         <span class="c1">######BOUNDARY C########: Tg[0]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">v_out1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>  <span class="c1">######BOUNDARY C########: Tg[-1]</span>
        <span class="c1"># column 2 dTgdt</span>
        <span class="n">inout_ratio_heat</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">inout_ratio_mass</span><span class="o">*</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span><span class="o">*</span><span class="n">inout_ratio_heat</span>  <span class="c1">######BOUNDARY C########</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">v_out2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">h2</span>        <span class="c1">######BOUNDARY C########</span>

        <span class="c1"># column 1&amp;2 T boundary conditions </span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTsdt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs1</span><span class="o">+</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg1</span><span class="o">-</span><span class="n">Ts1</span><span class="p">))</span><span class="o">/</span><span class="n">rho_s1</span><span class="o">/</span><span class="n">Cps1</span>
        <span class="n">dTsdt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs2</span><span class="o">+</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg2</span><span class="o">-</span><span class="n">Ts2</span><span class="p">))</span><span class="o">/</span><span class="n">rho_s2</span><span class="o">/</span><span class="n">Cps2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dTsdt1</span> <span class="o">=</span> <span class="n">dTsdt1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps1</span>
            <span class="n">dTsdt2</span> <span class="o">=</span> <span class="n">dTsdt2</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps2</span>

        <span class="n">dydt_tmp1</span> <span class="o">=</span> <span class="n">dCdt1</span><span class="o">+</span><span class="n">dqdt1</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt1</span><span class="p">]</span>
        <span class="n">dydt_tmp2</span> <span class="o">=</span> <span class="n">dCdt2</span><span class="o">+</span><span class="n">dqdt2</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt2</span><span class="p">]</span>
        <span class="n">dydt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp1</span><span class="p">)</span>
        <span class="n">dydt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp2</span><span class="p">)</span>
        
        <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dydt1</span><span class="p">,</span><span class="n">dydt2</span><span class="p">])</span>
        
        <span class="c1"># Check whether this converges</span>
        <span class="c1">#if np.max(np.abs(dydt1[0])) &gt; 100:</span>
        <span class="c1">#    aaa  = 100/0</span>
        <span class="c1">#bool_list = np.abs(dydt) &gt; y</span>
        <span class="c1">#if np.sum(bool_list) &gt; 0:</span>
        <span class="c1">#    dydt = 1/2*dydt</span>
        <span class="k">return</span> <span class="n">dydt</span>         
    <span class="n">C1_init</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">C2_init</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C1_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">*</span><span class="mf">1E5</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">T_mean</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">C2_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">*</span><span class="mf">1E5</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">T_mean</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
    <span class="n">y0_tot_gas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">C1_init</span><span class="o">+</span><span class="n">C2_init</span><span class="p">)</span>
    
    <span class="n">t_max_int_tneth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">n_t_tenth</span> <span class="o">=</span> <span class="n">t_max_int_tneth</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
    <span class="n">t_dom_tenth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_t_tenth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_max_int_tneth</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="o">/</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">t_dom_tenth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom_tenth</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="o">/</span><span class="mi">10</span><span class="p">]))</span>
    
    <span class="c1">#RUN1</span>
    <span class="n">y_res</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomeenbal_eq_gasonly</span><span class="p">,</span> <span class="n">y0_tot_gas</span><span class="p">,</span><span class="n">t_dom_tenth</span><span class="p">)</span>

    <span class="c1"># Update concentration</span>
    <span class="n">y0_tot</span><span class="p">[:</span><span class="n">N1</span><span class="o">*</span><span class="n">n_comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">N1</span><span class="o">*</span><span class="n">n_comp</span><span class="p">]</span>
    <span class="n">y0_tot</span><span class="p">[</span><span class="n">n_var_tot1</span><span class="p">:</span><span class="n">n_var_tot1</span><span class="o">+</span><span class="n">N2</span><span class="o">*</span><span class="n">n_comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N1</span><span class="o">*</span><span class="n">n_comp</span><span class="p">:]</span>
    <span class="c1"># Update temperature</span>
    <span class="n">y0_tot</span><span class="p">[</span><span class="n">n_var_tot1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="p">:</span><span class="n">n_var_tot1</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_mean</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
    <span class="n">y0_tot</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_mean</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
    
    <span class="c1">#RUN2</span>
    <span class="n">y_res</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomeenbal_eq</span><span class="p">,</span> <span class="n">y0_tot</span><span class="p">,</span><span class="n">t_dom</span><span class="p">)</span>
    <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,:</span><span class="n">n_var_tot1</span><span class="p">]</span>
    <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,</span><span class="n">n_var_tot1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">flip1_later</span><span class="p">:</span>
        <span class="n">y_res_flip1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_res1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
             <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span>
             <span class="n">y_res_flip1</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_tmp</span><span class="nd">@A_flip1</span>
        <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res_flip1</span>
    <span class="k">if</span> <span class="n">flip2_later</span><span class="p">:</span>
        <span class="n">y_res_flip2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_res2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span>
            <span class="n">y_res_flip2</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_tmp</span><span class="nd">@A_flip2</span>
        <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res_flip2</span>
    
    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
    <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
    <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
    <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>       
    <span class="n">column1</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
    <span class="n">column2</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
    <span class="k">if</span> <span class="n">switch_later</span><span class="p">:</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res2</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res1</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="n">N2</span><span class="p">]</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="n">N1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">y_res2</span><span class="p">,</span><span class="n">column1</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">],</span> <span class="p">[</span><span class="n">y_res1</span><span class="p">,</span><span class="n">column2</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res1</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res2</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="n">N2</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">y_res1</span><span class="p">,</span><span class="n">column1</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">],</span> <span class="p">[</span><span class="n">y_res2</span><span class="p">,</span><span class="n">column2</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">step_P_eq_alt2</span><span class="p">(</span><span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span>
<span class="n">n_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Cv_btw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">valve_select</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="c1"># in minute</span>
    <span class="n">P_sum1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column1</span><span class="o">.</span><span class="n">_P_init</span><span class="p">)</span>
    <span class="n">P_sum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column2</span><span class="o">.</span><span class="n">_P_init</span><span class="p">)</span>
    <span class="n">P_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_sum1</span><span class="o">+</span><span class="n">P_sum2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">T_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column1</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column2</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">P_sum1</span> <span class="o">&gt;</span> <span class="n">P_sum2</span><span class="p">:</span>
        <span class="n">c1_tmp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c2_tmp</span> <span class="o">=</span> <span class="n">column2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valve_select</span><span class="p">)</span>
        <span class="n">switch_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c1_tmp</span> <span class="o">=</span> <span class="n">column2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c2_tmp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">valve_select</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valve_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">switch_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">val_sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">A_flip1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
            <span class="n">A_flip1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="nd">@A_flip1</span>
        <span class="n">flip1_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flip1_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">val_sel</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">A_flip2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
            <span class="n">A_flip2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="nd">@A_flip2</span>
        <span class="n">flip2_later</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flip2_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">t_max_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="p">))</span>
    <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">n_t</span> <span class="o">=</span> <span class="n">t_max_int</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
    <span class="n">n_comp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">_n_comp</span>
    
    <span class="c1"># Target pressure</span>
    <span class="n">C_sta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_comp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C_sta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P_mean</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">T_mean</span><span class="o">*</span><span class="mf">1E5</span>

    <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max_int</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span>
    <span class="n">column1</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">column2</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="k">if</span> <span class="n">t_max_int</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">:</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="p">]))</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h</span>
    <span class="n">epsi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_epsi</span>
    <span class="n">epsi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_epsi</span>

    <span class="n">a_surf1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_a_surf</span>
    <span class="n">a_surf2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_a_surf</span>
    <span class="c1"># Mass</span>
    <span class="n">D_dis1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_disp</span>
    <span class="n">D_dis2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_disp</span>

    <span class="n">k_mass1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_k_mtc</span>
    <span class="n">k_mass2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_k_mtc</span>

    <span class="c1"># Heat</span>
    <span class="n">dH1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dH</span>
    <span class="n">dH2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dH</span>
    <span class="n">Cpg1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Cp_g</span>
    <span class="n">Cpg2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Cp_g</span>
    
    <span class="n">Cps1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Cp_s</span>
    <span class="n">Cps2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Cp_s</span>

    <span class="n">h_heat1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h_heat</span>
    <span class="n">h_heat2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h_heat</span>

    <span class="n">h_ambi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h_ambi</span>
    <span class="n">h_ambi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h_ambi</span>

    <span class="n">T_ambi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_T_ambi</span>
    <span class="n">T_ambi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_T_ambi</span>

    <span class="c1"># other parmeters</span>
    <span class="n">rho_s1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_rho_s</span>
    <span class="n">rho_s2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_rho_s</span>
    <span class="n">D_col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">D_col2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

    <span class="n">n_var_tot1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_n_comp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">n_var_tot2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_n_comp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    
    <span class="c1"># Initial conditions</span>
    <span class="n">y01</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y02</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C1_tmp</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mf">1E5</span>    <span class="c1"># in (mol/m^3)</span>
        <span class="n">C2_tmp</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mf">1E5</span>    <span class="c1"># in (mol/m^3)</span>
        <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1_tmp</span><span class="p">)</span>
        <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2_tmp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
    <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span>
    <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span>
    <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">)</span>
    <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">)</span>
    <span class="n">y01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y01</span><span class="p">)</span>
    <span class="n">y02</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y02</span><span class="p">)</span>
    <span class="n">y0_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y01</span><span class="p">,</span><span class="n">y02</span><span class="p">])</span>

    <span class="c1"># ODE function</span>
    <span class="k">def</span> <span class="nf">massmomeenbal_eq</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">n_var_tot1</span><span class="p">]</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n_var_tot1</span><span class="p">:]</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">C2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
            <span class="n">q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">q2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
        <span class="n">Tg1</span> <span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">N1</span> <span class="p">]</span>
        <span class="n">Tg2</span> <span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N2</span> <span class="p">]</span>
        <span class="n">Ts1</span> <span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">N1</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">]</span>
        <span class="n">Ts2</span> <span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N2</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">]</span>

        <span class="c1"># Derivatives</span>
        <span class="n">dC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_part1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P_part2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="c1">#T = self._Tg_init</span>
        <span class="c1"># Temperature gradient:</span>
        <span class="n">dTg1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg1</span>
        <span class="n">dTg2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg2</span>
        <span class="n">ddTs1</span> <span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts1</span>
        <span class="n">ddTs2</span> <span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts2</span>

        <span class="c1"># Concentration gradient</span>
        <span class="c1"># Pressure (overall&amp;partial)</span>
        <span class="c1"># Viscosity</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">dC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">P_part1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg1</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">P_part2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg2</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">C_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">C_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">P_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg1</span>
            <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">P_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg2</span>
            <span class="n">Mu1</span> <span class="o">=</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu2</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">Mu1</span><span class="o">/</span><span class="n">C_ov1</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">Mu2</span><span class="o">/</span><span class="n">C_ov2</span>

        <span class="c1"># Ergun equation</span>
        <span class="n">v1</span><span class="p">,</span><span class="n">dv1</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span><span class="n">Tg1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi1</span><span class="p">,</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N1</span><span class="p">)</span>
        <span class="n">v2</span><span class="p">,</span><span class="n">dv2</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span><span class="n">Tg2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi2</span><span class="p">,</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N2</span><span class="p">)</span>
        
        <span class="c1"># Solid phase concentration</span>
        <span class="n">qsta1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part1</span><span class="p">,</span> <span class="n">Tg1</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
        <span class="n">qsta2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part2</span><span class="p">,</span> <span class="n">Tg2</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
        <span class="n">dqdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dqdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf1</span>
                <span class="n">dqdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf1</span> <span class="o">+</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">a_surf1</span>
                <span class="n">dqdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf2</span>
                <span class="n">dqdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf2</span> <span class="o">+</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">a_surf2</span>
                <span class="n">dqdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>        

        <span class="c1"># Valve equations (v_in and v_out)</span>
        <span class="n">v_in1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_out2</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">v_out1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
        <span class="n">v_in2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
        
        <span class="c1"># Gas phase concentration</span>
        <span class="n">dCdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dCdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv1</span> <span class="o">+</span> <span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="c1">#dCdt_tmp[0] = +(v_in1*0 - v1[1]*C1[ii][0])/h1 - (1-epsi1)/epsi1*rho_s1*dqdt1[ii][0]               ######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">C_sta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>               <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_out1</span><span class="o">+</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">######BOUNDARY C######## (KEY PROBLEM)</span>
            <span class="n">dCdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
        <span class="n">inout_ratio_mass</span><span class="o">=</span><span class="n">epsi1</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv2</span> <span class="o">+</span> <span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">inout_ratio_mass</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">v_out2</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">######BOUNDARY C########</span>
            <span class="n">dCdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>

        <span class="c1"># Temperature (gas)</span>
        <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span> <span class="o">+</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">Cov_Cpg2</span> <span class="o">+</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dTgdt1</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dTg1</span> <span class="o">+</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
        <span class="n">dTgdt2</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dTg2</span> <span class="o">+</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="c1"># column 1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">-</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg1</span><span class="o">*</span><span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">+</span> <span class="n">Tg1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">+</span> <span class="n">h_ambi1</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi1</span><span class="o">/</span><span class="n">D_col1</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi1</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="c1"># column 2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">-</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="o">*</span><span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">+</span> <span class="n">Tg2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">+</span> <span class="n">h_ambi2</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">D_col2</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi2</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span>

        <span class="c1"># column 1 dTgdt</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_in1</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>                         <span class="c1">######BOUNDARY C########: Tg[0]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">v_out1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>  <span class="c1">######BOUNDARY C########: Tg[-1]</span>
        <span class="c1"># column 2 dTgdt</span>
        <span class="n">inout_ratio_heat</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">inout_ratio_mass</span><span class="o">*</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span><span class="o">*</span><span class="n">inout_ratio_heat</span>  <span class="c1">######BOUNDARY C########</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">v_out2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">h2</span>        <span class="c1">######BOUNDARY C########</span>

        <span class="c1"># column 1&amp;2 T boundary conditions </span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTsdt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs1</span><span class="o">+</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg1</span><span class="o">-</span><span class="n">Ts1</span><span class="p">))</span><span class="o">/</span><span class="n">rho_s1</span><span class="o">/</span><span class="n">Cps1</span>
        <span class="n">dTsdt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs2</span><span class="o">+</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg2</span><span class="o">-</span><span class="n">Ts2</span><span class="p">))</span><span class="o">/</span><span class="n">rho_s2</span><span class="o">/</span><span class="n">Cps2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dTsdt1</span> <span class="o">=</span> <span class="n">dTsdt1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps1</span>
            <span class="n">dTsdt2</span> <span class="o">=</span> <span class="n">dTsdt2</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dydt_tmp1</span> <span class="o">=</span> <span class="n">dCdt1</span><span class="o">+</span><span class="n">dqdt1</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt1</span><span class="p">]</span>
        <span class="n">dydt_tmp2</span> <span class="o">=</span> <span class="n">dCdt2</span><span class="o">+</span><span class="n">dqdt2</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt2</span><span class="p">]</span>
        <span class="n">dydt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp1</span><span class="p">)</span>
        <span class="n">dydt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp2</span><span class="p">)</span>
        
        <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dydt1</span><span class="p">,</span><span class="n">dydt2</span><span class="p">])</span>
        
        <span class="c1"># Check whether this converges</span>
        <span class="c1">#if np.max(np.abs(dydt1[0])) &gt; 100:</span>
        <span class="c1">#    aaa  = 100/0</span>
        <span class="c1">#bool_list = np.abs(dydt) &gt; y</span>
        <span class="c1">#if np.sum(bool_list) &gt; 0:</span>
        <span class="c1">#    dydt = 1/2*dydt</span>
        <span class="k">return</span> <span class="n">dydt</span>         
    
    <span class="c1">#RUN</span>
    <span class="n">y_res</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomeenbal_eq</span><span class="p">,</span> <span class="n">y0_tot</span><span class="p">,</span><span class="n">t_dom</span><span class="p">)</span>
    <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,:</span><span class="n">n_var_tot1</span><span class="p">]</span>
    <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,</span><span class="n">n_var_tot1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">flip1_later</span><span class="p">:</span>
        <span class="n">y_res_flip1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_res1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
             <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span>
             <span class="n">y_res_flip1</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_tmp</span><span class="nd">@A_flip1</span>
        <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res_flip1</span>
    <span class="k">if</span> <span class="n">flip2_later</span><span class="p">:</span>
        <span class="n">y_res_flip2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_res2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span>
            <span class="n">y_res_flip2</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_tmp</span><span class="nd">@A_flip2</span>
        <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res_flip2</span>
    
    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
    <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
    <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
    <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>       
    <span class="n">column1</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
    <span class="n">column2</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
    <span class="k">if</span> <span class="n">switch_later</span><span class="p">:</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res2</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res1</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="n">N2</span><span class="p">]</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="n">N1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">y_res2</span><span class="p">,</span><span class="n">column1</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">],</span> <span class="p">[</span><span class="n">y_res1</span><span class="p">,</span><span class="n">column2</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res1</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res2</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="n">N2</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">y_res1</span><span class="p">,</span><span class="n">column1</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">],</span> <span class="p">[</span><span class="n">y_res2</span><span class="p">,</span><span class="n">column2</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">]]</span>




<span class="k">def</span> <span class="nf">step_P_eq</span><span class="p">(</span><span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span>
<span class="n">n_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Cv_btw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">valve_select</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="c1"># in minute</span>
    <span class="n">P_sum1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column1</span><span class="o">.</span><span class="n">_P_init</span><span class="p">)</span>
    <span class="n">P_sum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column2</span><span class="o">.</span><span class="n">_P_init</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">P_sum1</span> <span class="o">&gt;</span> <span class="n">P_sum2</span><span class="p">:</span>
        <span class="n">c1_tmp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c2_tmp</span> <span class="o">=</span> <span class="n">column2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valve_select</span><span class="p">)</span>
        <span class="n">switch_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c1_tmp</span> <span class="o">=</span> <span class="n">column2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c2_tmp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">valve_select</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valve_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">switch_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">val_sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">A_flip1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
            <span class="n">A_flip1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="nd">@A_flip1</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="nd">@A_flip1</span>
        <span class="n">flip1_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flip1_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">val_sel</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">A_flip2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span><span class="p">):</span>
            <span class="n">A_flip2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span> <span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="nd">@A_flip2</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="nd">@A_flip2</span>
        <span class="n">flip2_later</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flip2_later</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">t_max_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t_max</span><span class="p">))</span>
    <span class="n">column1</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">column2</span><span class="o">.</span><span class="n">_n_sec</span> <span class="o">=</span> <span class="n">n_sec</span>
    <span class="n">n_t</span> <span class="o">=</span> <span class="n">t_max_int</span><span class="o">*</span><span class="n">n_sec</span><span class="o">+</span> <span class="mi">1</span>
    <span class="n">n_comp</span> <span class="o">=</span> <span class="n">column1</span><span class="o">.</span><span class="n">_n_comp</span>
    
    <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t_max_int</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_max_int</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">:</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_dom</span><span class="p">,</span> <span class="p">[</span><span class="n">t_max</span><span class="p">]))</span>
    <span class="n">N1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h</span>
    <span class="n">epsi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_epsi</span>
    <span class="n">epsi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_epsi</span>

    <span class="n">a_surf1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_a_surf</span>
    <span class="n">a_surf2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_a_surf</span>
    <span class="c1"># Mass</span>
    <span class="n">D_dis1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_disp</span>
    <span class="n">D_dis2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_disp</span>

    <span class="n">k_mass1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_k_mtc</span>
    <span class="n">k_mass2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_k_mtc</span>

    <span class="c1"># Heat</span>
    <span class="n">dH1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dH</span>
    <span class="n">dH2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dH</span>
    <span class="n">Cpg1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Cp_g</span>
    <span class="n">Cpg2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Cp_g</span>
    
    <span class="n">Cps1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Cp_s</span>
    <span class="n">Cps2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Cp_s</span>

    <span class="n">h_heat1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h_heat</span>
    <span class="n">h_heat2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h_heat</span>

    <span class="n">h_ambi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_h_ambi</span>
    <span class="n">h_ambi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_h_ambi</span>

    <span class="n">T_ambi1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_T_ambi</span>
    <span class="n">T_ambi2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_T_ambi</span>

    <span class="c1"># other parmeters</span>
    <span class="n">rho_s1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_rho_s</span>
    <span class="n">rho_s2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_rho_s</span>
    <span class="n">D_col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">D_col2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

    <span class="n">n_var_tot1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_n_comp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">n_var_tot2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_n_comp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
    
    <span class="c1"># Initial conditions</span>
    <span class="n">y01</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y02</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C1_tmp</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mf">1E5</span>    <span class="c1"># in (mol/m^3)</span>
        <span class="n">C2_tmp</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_P_init</span><span class="o">/</span><span class="n">R_gas</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_y_init</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mf">1E5</span>    <span class="c1"># in (mol/m^3)</span>
        <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1_tmp</span><span class="p">)</span>
        <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2_tmp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_q_init</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
    <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span>
    <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Tg_init</span><span class="p">)</span>
    <span class="n">y01</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">)</span>
    <span class="n">y02</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_Ts_init</span><span class="p">)</span>
    <span class="n">y01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y01</span><span class="p">)</span>
    <span class="n">y02</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y02</span><span class="p">)</span>
    <span class="n">y0_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y01</span><span class="p">,</span><span class="n">y02</span><span class="p">])</span>

    <span class="c1"># ODE function</span>
    <span class="k">def</span> <span class="nf">massmomeenbal_eq</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">n_var_tot1</span><span class="p">]</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n_var_tot1</span><span class="p">:]</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">C2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
            <span class="n">q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">])</span>
            <span class="n">q2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">])</span>
        <span class="n">Tg1</span> <span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">N1</span> <span class="p">]</span>
        <span class="n">Tg2</span> <span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N2</span> <span class="p">]</span>
        <span class="n">Ts1</span> <span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="n">N1</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">]</span>
        <span class="n">Ts2</span> <span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="n">N2</span> <span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_comp</span><span class="o">*</span><span class="n">N2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">]</span>

        <span class="c1"># Derivatives</span>
        <span class="n">dC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddC2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="n">P_part1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P_part2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="c1">#T = self._Tg_init</span>
        <span class="c1"># Temperature gradient:</span>
        <span class="n">dTg1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg1</span>
        <span class="n">dTg2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@Tg2</span>
        <span class="n">ddTs1</span> <span class="o">=</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts1</span>
        <span class="n">ddTs2</span> <span class="o">=</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@Ts2</span>

        <span class="c1"># Concentration gradient</span>
        <span class="c1"># Pressure (overall&amp;partial)</span>
        <span class="c1"># Viscosity</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">dC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">ddC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="nd">@C2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">P_part1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg1</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">P_part2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg2</span><span class="o">/</span><span class="mf">1E5</span><span class="p">)</span> <span class="c1"># in bar</span>
            <span class="n">C_ov1</span> <span class="o">=</span> <span class="n">C_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">C_ov2</span> <span class="o">=</span> <span class="n">C_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">P_ov1</span> <span class="o">=</span> <span class="n">P_ov1</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg1</span>
            <span class="n">P_ov2</span> <span class="o">=</span> <span class="n">P_ov2</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">R_gas</span><span class="o">*</span><span class="n">Tg2</span>
            <span class="n">Mu1</span> <span class="o">=</span> <span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Mu2</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_mu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">Mu1</span> <span class="o">=</span> <span class="n">Mu1</span><span class="o">/</span><span class="n">C_ov1</span>
        <span class="n">Mu2</span> <span class="o">=</span> <span class="n">Mu2</span><span class="o">/</span><span class="n">C_ov2</span>

        <span class="c1"># Ergun equation</span>
        <span class="n">v1</span><span class="p">,</span><span class="n">dv1</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span><span class="n">Tg1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu1</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi1</span><span class="p">,</span>
        <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N1</span><span class="p">)</span>
        <span class="n">v2</span><span class="p">,</span><span class="n">dv2</span> <span class="o">=</span> <span class="n">Ergun</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span><span class="n">Tg2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_M_m</span><span class="p">,</span><span class="n">Mu2</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_D_p</span><span class="p">,</span><span class="n">epsi2</span><span class="p">,</span>
        <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_d_fo</span><span class="p">,</span> <span class="n">N2</span><span class="p">)</span>
        
        <span class="c1"># Solid phase concentration</span>
        <span class="n">qsta1</span> <span class="o">=</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part1</span><span class="p">,</span> <span class="n">Tg1</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
        <span class="n">qsta2</span> <span class="o">=</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_iso</span><span class="p">(</span><span class="n">P_part2</span><span class="p">,</span> <span class="n">Tg2</span><span class="p">)</span> <span class="c1"># partial pressure in bar</span>
        <span class="n">dqdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dqdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf1</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
                <span class="n">dqdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf1</span> <span class="o">+</span> <span class="n">k_mass1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">a_surf1</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span>
                <span class="n">dqdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf2</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
                <span class="n">dqdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_order_MTC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">a_surf2</span> <span class="o">+</span> <span class="n">k_mass2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">qsta2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">a_surf2</span>
                <span class="n">dqdt_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
                <span class="n">dqdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dqdt_tmp</span><span class="p">)</span>        

        <span class="c1"># Valve equations (v_in and v_out)</span>
        <span class="n">v_in1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v_out2</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">v_out1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar</span>
        <span class="n">v_in2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Cv_btw</span><span class="o">*</span><span class="p">(</span><span class="n">P_ov1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span> <span class="o">-</span> <span class="n">P_ov2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1E5</span><span class="p">),</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1"># pressure in bar           </span>
        
        <span class="c1"># Gas phase concentration</span>
        <span class="n">dCdt1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dCdt2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv1</span> <span class="o">+</span> <span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in1</span><span class="o">*</span><span class="mi">0</span> <span class="o">-</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">v_out1</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dCdt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>
        <span class="n">inout_ratio_mass</span><span class="o">=</span><span class="n">epsi1</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt_tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dv2</span> <span class="o">+</span> <span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">inout_ratio_mass</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dCdt_tmp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span> <span class="n">v_out2</span><span class="o">*</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">h2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dCdt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dCdt_tmp</span><span class="p">)</span>

        <span class="c1"># Temperature (gas)</span>
        <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N1</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span> <span class="c1"># Heat capacity (overall) J/K/m^3</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">Cov_Cpg1</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span> <span class="o">+</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Cov_Cpg2</span> <span class="o">=</span> <span class="n">Cov_Cpg2</span> <span class="o">+</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dTgdt1</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">*</span><span class="n">dTg1</span> <span class="o">+</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
        <span class="n">dTgdt2</span> <span class="o">=</span> <span class="o">-</span><span class="n">v2</span><span class="o">*</span><span class="n">dTg2</span> <span class="o">+</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="c1"># column 1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">-</span> <span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg1</span><span class="o">*</span><span class="n">D_dis1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">+</span> <span class="n">Tg1</span><span class="o">*</span><span class="n">rho_s1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="n">dTgdt1</span> <span class="o">=</span> <span class="n">dTgdt1</span> <span class="o">+</span> <span class="n">h_ambi1</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi1</span><span class="o">/</span><span class="n">D_col1</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi1</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg1</span>
            <span class="c1"># column 2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">-</span> <span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="o">*</span><span class="n">D_dis2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">ddC2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">+</span> <span class="n">Tg2</span><span class="o">*</span><span class="n">rho_s2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span>
            <span class="n">dTgdt2</span> <span class="o">=</span> <span class="n">dTgdt2</span> <span class="o">+</span> <span class="n">h_ambi2</span><span class="o">*</span><span class="mi">4</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">D_col2</span><span class="o">*</span><span class="p">(</span><span class="n">T_ambi2</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span>

        <span class="c1"># column 1 dTgdt</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v_in1</span><span class="o">*</span><span class="mi">0</span>  <span class="o">-</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="n">epsi1</span><span class="o">*</span><span class="p">(</span><span class="n">Ts1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_out1</span><span class="o">*</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">h1</span>
        <span class="c1"># column 2 dTgdt</span>
        <span class="n">inout_ratio_heat</span> <span class="o">=</span> <span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">epsi1</span><span class="o">*</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_A</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">epsi2</span><span class="o">/</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_A</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v_in2</span><span class="o">*</span><span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">inout_ratio_heat</span>  <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h2</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="n">epsi2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_out2</span><span class="o">*</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">h2</span>
                
        <span class="c1"># column 1&amp;2 T boundary conditions </span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTgdt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Tg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Cpg2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">Cov_Cpg2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dTsdt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1_tmp</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs1</span><span class="o">+</span> <span class="n">h_heat1</span><span class="o">*</span><span class="n">a_surf1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg1</span><span class="o">-</span><span class="n">Ts1</span><span class="p">))</span><span class="o">/</span><span class="n">rho_s1</span><span class="o">/</span><span class="n">Cps1</span>
        <span class="n">dTsdt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2_tmp</span><span class="o">.</span><span class="n">_k_cond</span><span class="o">*</span><span class="n">ddTs2</span><span class="o">+</span> <span class="n">h_heat2</span><span class="o">*</span><span class="n">a_surf2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsi2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Tg2</span><span class="o">-</span><span class="n">Ts2</span><span class="p">))</span><span class="o">/</span><span class="n">rho_s2</span><span class="o">/</span><span class="n">Cps2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dTsdt1</span> <span class="o">=</span> <span class="n">dTsdt1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH1</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps1</span>
            <span class="n">dTsdt2</span> <span class="o">=</span> <span class="n">dTsdt2</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dH2</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">dqdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">Cps2</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dCdt1</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dCdt2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dydt_tmp1</span> <span class="o">=</span> <span class="n">dCdt1</span><span class="o">+</span><span class="n">dqdt1</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt1</span><span class="p">]</span>
        <span class="n">dydt_tmp2</span> <span class="o">=</span> <span class="n">dCdt2</span><span class="o">+</span><span class="n">dqdt2</span><span class="o">+</span><span class="p">[</span><span class="n">dTgdt2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dTsdt2</span><span class="p">]</span>
        <span class="n">dydt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp1</span><span class="p">)</span>
        <span class="n">dydt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dydt_tmp2</span><span class="p">)</span>
        
        <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dydt1</span><span class="p">,</span><span class="n">dydt2</span><span class="p">])</span>
        
        <span class="c1"># Check whether this converges</span>
        <span class="c1">#if np.max(np.abs(dydt1[0])) &gt; 100:</span>
        <span class="c1">#    aaa  = 100/0</span>
        <span class="c1">#bool_list = np.abs(dydt) &gt; y</span>
        <span class="c1">#if np.sum(bool_list) &gt; 0:</span>
        <span class="c1">#    dydt = 1/2*dydt</span>
        <span class="k">return</span> <span class="n">dydt</span>         

    <span class="c1">#RUN</span>
    <span class="n">y_res</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">massmomeenbal_eq</span><span class="p">,</span> <span class="n">y0_tot</span><span class="p">,</span><span class="n">t_dom</span><span class="p">)</span>
    <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,:</span><span class="n">n_var_tot1</span><span class="p">]</span>
    <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,</span><span class="n">n_var_tot1</span><span class="p">:]</span>
    <span class="n">C_sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">C_sum</span> <span class="o">=</span> <span class="n">C_sum</span> <span class="o">+</span> <span class="n">y_res1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">C_sum</span> <span class="o">=</span> <span class="n">C_sum</span> <span class="o">+</span> <span class="n">y_res2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">C_sum</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">y_res12</span> <span class="o">=</span> <span class="n">step_P_eq_alt1</span><span class="p">(</span><span class="n">column1</span><span class="p">,</span><span class="n">column2</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_sec</span> <span class="o">=</span> <span class="n">n_sec</span><span class="p">,</span>
        <span class="n">Cv_btw</span> <span class="o">=</span> <span class="n">Cv_btw</span><span class="p">,</span> <span class="n">valve_select</span> <span class="o">=</span> <span class="n">valve_select</span><span class="p">)</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
        <span class="n">C_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,:</span><span class="n">n_var_tot1</span><span class="p">]</span>
        <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res</span><span class="p">[:,</span><span class="n">n_var_tot1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            <span class="n">C_sum</span> <span class="o">=</span> <span class="n">C_sum</span> <span class="o">+</span> <span class="n">y_res1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">C_sum</span> <span class="o">=</span> <span class="n">C_sum</span> <span class="o">+</span> <span class="n">y_res2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y_res12</span>
        <span class="k">if</span> <span class="n">C_sum</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">y_res12</span> <span class="o">=</span> <span class="n">step_P_eq_alt2</span><span class="p">(</span><span class="n">column1</span><span class="p">,</span><span class="n">column2</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">n_sec</span> <span class="o">=</span> <span class="n">n_sec</span><span class="p">,</span>
            <span class="n">Cv_btw</span> <span class="o">=</span> <span class="n">Cv_btw</span><span class="p">,</span> <span class="n">valve_select</span> <span class="o">=</span> <span class="n">valve_select</span><span class="p">)</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
            <span class="n">column1</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
            <span class="n">column2</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
            <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">y_res12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column1</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
            <span class="n">column2</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
            <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">y_res12</span>
    <span class="k">if</span> <span class="n">flip1_later</span><span class="p">:</span>
        <span class="n">y_res_flip1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_res1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
             <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span>
             <span class="n">y_res_flip1</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N1</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_tmp</span><span class="nd">@A_flip1</span>
        <span class="n">y_res1</span> <span class="o">=</span> <span class="n">y_res_flip1</span>
    <span class="k">if</span> <span class="n">flip2_later</span><span class="p">:</span>
        <span class="n">y_res_flip2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_res2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span>
            <span class="n">y_res_flip2</span><span class="p">[:,</span><span class="n">ii</span><span class="o">*</span><span class="n">N2</span><span class="p">:(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_tmp</span><span class="nd">@A_flip2</span>
        <span class="n">y_res2</span> <span class="o">=</span> <span class="n">y_res_flip2</span>
    
    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span> <span class="o">-</span> <span class="n">tic</span>
    <span class="n">c1_tmp</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
    <span class="n">c2_tmp</span><span class="o">.</span><span class="n">_CPU_min</span> <span class="o">=</span> <span class="n">toc</span>
    <span class="k">if</span> <span class="n">CPUtime_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation of this step is completed.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This took </span><span class="si">{0:9.3f}</span><span class="s1"> mins to run. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toc</span><span class="p">))</span>       
    <span class="n">column1</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
    <span class="n">column2</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">t_dom</span>
    <span class="k">if</span> <span class="n">switch_later</span><span class="p">:</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res2</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res1</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="n">N2</span><span class="p">]</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="n">N1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">y_res2</span><span class="p">,</span><span class="n">column1</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">],</span> <span class="p">[</span><span class="n">y_res1</span><span class="p">,</span><span class="n">column2</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res1</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y_res2</span>
        <span class="n">column1</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res1</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N1</span><span class="o">+</span><span class="n">N1</span><span class="p">]</span>
        <span class="n">column2</span><span class="o">.</span><span class="n">_Tg_res</span> <span class="o">=</span> <span class="n">y_res2</span><span class="p">[:,</span><span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span> <span class="p">:</span> <span class="n">n_comp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N2</span><span class="o">+</span><span class="n">N2</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">y_res1</span><span class="p">,</span><span class="n">column1</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">],</span> <span class="p">[</span><span class="n">y_res2</span><span class="p">,</span><span class="n">column2</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">]]</span>
    
<span class="c1"># %% When only this code is run (name == main)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">A_cros</span> <span class="o">=</span> <span class="mf">0.031416</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">A_cros</span><span class="p">,</span> <span class="n">n_component</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">N_node</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    dP = np.linspace(-100, 100)</span>
<span class="sd">    M_m_test  = [0.044, 0.028]      ## molar mass    (kg/mol)</span>
<span class="sd">    mu_test = [1.47E-5, 1.74E-5]    ## gas viscosity (Pa sec)</span>
<span class="sd">    D_particle_dia = 0.01   # particle diameter (m)</span>
<span class="sd">    epsi_test = 0.4         # macroscopic void fraction (m^3/m^3)</span>
<span class="sd">    v_test = Ergun_test(dP,M_m_test[0],mu_test[0],D_particle_dia,epsi_test)</span>
<span class="sd">    plt.plot(dP,v_test)</span>
<span class="sd">    plt.grid()</span>
<span class="sd">    plt.show()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">## Adsorbent</span>
    <span class="n">isopar1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">isopar2</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">iso_fn_test</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">isopar1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">30E3</span><span class="o">/</span><span class="mf">8.3145</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">300</span><span class="p">))</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">isopar2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">20E3</span><span class="o">/</span><span class="mf">8.3145</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">300</span><span class="p">))</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">b1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">numor0</span> <span class="o">=</span> <span class="n">isopar1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b1</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">numor1</span> <span class="o">=</span> <span class="n">isopar2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b2</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">q_return</span> <span class="o">=</span> <span class="p">[</span><span class="n">numor0</span><span class="o">/</span><span class="n">denom</span><span class="p">,</span> <span class="n">numor1</span><span class="o">/</span><span class="n">denom</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">q_return</span>
 
    <span class="n">epsi_test</span> <span class="o">=</span> <span class="mf">0.4</span>         <span class="c1"># macroscopic void fraction (m^3/m^3)</span>
    <span class="n">D_particle_dia</span> <span class="o">=</span> <span class="mf">0.01</span>   <span class="c1"># particle diameter (m)</span>
    <span class="n">rho_s_test</span> <span class="o">=</span> <span class="mi">1100</span>       <span class="c1"># solid density (kg/mol)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">adsorbent_info</span><span class="p">(</span><span class="n">iso_fn_test</span><span class="p">,</span><span class="n">epsi_test</span><span class="p">,</span><span class="n">D_particle_dia</span><span class="p">,</span> <span class="n">rho_s_test</span><span class="p">)</span>
 
    <span class="n">M_m_test</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.044</span><span class="p">,</span> <span class="mf">0.028</span><span class="p">]</span>      <span class="c1">## molar mass    (kg/mol)</span>
    <span class="n">mu_test</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.47E-5</span><span class="p">,</span> <span class="mf">1.74E-5</span><span class="p">]</span>    <span class="c1">## gas viscosity (Pa sec)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">gas_prop_info</span><span class="p">(</span><span class="n">M_m_test</span><span class="p">,</span> <span class="n">mu_test</span><span class="p">)</span>
 
    <span class="c1">## Mass transfer coefficients</span>
    <span class="n">D_dis_test</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1E-6</span><span class="p">,</span> <span class="mf">1E-6</span><span class="p">]</span>   <span class="c1"># m^2/sec</span>
    <span class="n">k_MTC</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0002</span><span class="p">,</span> <span class="mf">0.0002</span><span class="p">]</span>    <span class="c1"># m/sec</span>
    <span class="n">a_surf</span> <span class="o">=</span> <span class="mi">400</span>                <span class="c1"># m^2/m^3</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">mass_trans_info</span><span class="p">(</span><span class="n">k_MTC</span><span class="p">,</span> <span class="n">a_surf</span><span class="p">,</span> <span class="n">D_dis_test</span><span class="p">)</span>

    <span class="c1">## Thermal properties</span>
    <span class="n">Del_H</span> <span class="o">=</span> <span class="p">[</span><span class="mf">30E3</span><span class="p">,</span> <span class="mf">20E3</span><span class="p">]</span>    <span class="c1"># J/mol</span>
    <span class="n">Cp_s</span> <span class="o">=</span> <span class="mi">935</span>              <span class="c1"># J/kg/K</span>
    <span class="n">Cp_g</span> <span class="o">=</span> <span class="p">[</span><span class="mf">37.22</span><span class="p">,</span> <span class="mf">29.15</span><span class="p">]</span>   <span class="c1"># J/mol/K</span>
    <span class="n">h_heat</span> <span class="o">=</span> <span class="mi">100</span>            <span class="c1"># J/sec/m^2/K</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">thermal_info</span><span class="p">(</span><span class="n">Del_H</span><span class="p">,</span><span class="n">Cp_s</span><span class="p">,</span><span class="n">Cp_g</span><span class="p">,</span><span class="n">h_heat</span><span class="p">,)</span>

    <span class="c1">## Boundary condition</span>
    <span class="n">Pin_test</span> <span class="o">=</span> <span class="mf">1.5</span>      <span class="c1"># inlet pressure (bar)</span>
    <span class="n">yin_test</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># inlet composition (mol/mol)</span>
    <span class="n">Tin_test</span> <span class="o">=</span> <span class="mi">300</span>      <span class="c1"># inlet temperature (K)</span>
    <span class="n">Q_in_test</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="mf">0.031416</span><span class="o">*</span><span class="mf">0.3</span>  <span class="c1"># volumetric flowrate (m^3/sec)</span>
    <span class="n">Cvin_test</span> <span class="o">=</span> <span class="mf">1E-1</span>    <span class="c1"># inlet valve constant (m/sec/bar)</span>
 
    <span class="n">Pout_test</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># outlet pressure (bar)</span>
    <span class="n">Cvout_test</span> <span class="o">=</span> <span class="mf">2E-2</span>   <span class="c1"># outlet valve constant (m/sec/bar)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">boundaryC_info</span><span class="p">(</span><span class="n">Pout_test</span><span class="p">,</span><span class="n">Pin_test</span><span class="p">,</span><span class="n">Tin_test</span><span class="p">,</span><span class="n">yin_test</span><span class="p">,</span>
    <span class="n">Cvin_test</span><span class="p">,</span><span class="n">Cvout_test</span><span class="p">,</span><span class="n">Q_in_test</span><span class="p">,</span><span class="n">assigned_v_option</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
 
    <span class="c1">#c1.boundaryC_info(Pout_test, Pin_test,Tin_test,yin_test,Cvin_test)</span>
 
    <span class="c1">## Initial condition</span>
    <span class="n">P_init</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>                   <span class="c1"># initial pressure (bar)</span>
    <span class="n">y_init</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>   <span class="c1"># initial composition (mol/mol)</span>
    <span class="n">T_init</span> <span class="o">=</span> <span class="mi">300</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>                 <span class="c1"># initial temperature (K)</span>
    <span class="n">q_init</span> <span class="o">=</span> <span class="n">iso_fn_test</span><span class="p">([</span><span class="n">P_init</span><span class="o">*</span><span class="n">y_init</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">P_init</span><span class="o">*</span><span class="n">y_init</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">T_init</span><span class="p">)</span>               <span class="c1"># initial uptake</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">initialC_info</span><span class="p">(</span><span class="n">P_init</span><span class="p">,</span> <span class="n">T_init</span><span class="p">,</span> <span class="n">T_init</span><span class="p">,</span><span class="n">y_init</span><span class="p">,</span><span class="n">q_init</span><span class="p">)</span>
    
    <span class="c1">## print here</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">run_mamoen</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="n">CPUtime_print</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span>
        <span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.85</span><span class="p">],</span> 
        <span class="n">yaxis_label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C$_</span><span class="si">{1}</span><span class="s1">$ (mol/m$^</span><span class="si">{3}</span><span class="s1">$)&#39;</span><span class="p">,</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">8.5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">Graph_P</span><span class="p">(</span>
        <span class="mi">100</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">0.85</span><span class="p">],</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">8.5</span><span class="p">,</span><span class="mi">5</span><span class="p">],)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">next_init</span><span class="p">()</span>

    <span class="n">c1</span><span class="o">.</span><span class="n">boundaryC_info</span><span class="p">(</span><span class="n">Pout_test</span><span class="p">,</span><span class="n">Pin_test</span><span class="p">,</span><span class="n">Tin_test</span><span class="p">,</span><span class="n">yin_test</span><span class="p">,</span>
    <span class="mf">0.0</span><span class="o">*</span><span class="n">Cvin_test</span><span class="p">,</span><span class="n">Cvout_test</span><span class="p">,</span><span class="n">Q_in_test</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span> <span class="n">foward_flow_direction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">boundaryC_info</span><span class="p">(</span><span class="n">Pout_test</span><span class="p">,</span><span class="n">Pin_test</span><span class="p">,</span><span class="n">Tin_test</span><span class="p">,</span><span class="n">yin_test</span><span class="p">,</span>
    <span class="mf">0.0</span><span class="o">*</span><span class="n">Cvin_test</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Q_in_test</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span> <span class="n">foward_flow_direction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">step_P_eq</span><span class="p">(</span>
        <span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">n_sec</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">valve_select</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">Cv_btw</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">CPUtime_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">Legend_loc</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">Graph_P</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">Legend_loc</span><span class="p">)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span><span class="n">Legend_loc</span><span class="p">)</span>
    <span class="n">c1</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span><span class="n">Legend_loc</span><span class="p">)</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">Graph_P</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span><span class="n">Legend_loc</span><span class="p">)</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span><span class="n">Legend_loc</span><span class="p">)</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">Legend_loc</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span> <span class="p">)</span>
    
<span class="c1"># %%</span>

<span class="c1"># %%</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, anna.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>